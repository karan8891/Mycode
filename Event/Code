def parse_apmf_event(**kwargs):
    ti = kwargs["ti"]
    raw = ti.xcom_pull(task_ids="wait_for_apmf_message")

    try:
        parsed = json.loads(raw)  # parsed raw string to dict
        batch = json.loads(parsed["message"]["data"])  # decode base64-style JSON payload
        file_events = batch["file_events"]
    except Exception as e:
        raise ValueError(f"[ERROR] Failed to parse message: {raw}, error: {e}")

    # Group events by `delete_source_files_after_transfer` flag
    grouped = {
        True: [],
        False: []
    }

    for event in file_events:
        flag = event.get("delete_source_files_after_transfer", False)
        grouped[flag].append(event)

    # Push grouped events to XCom
    ti.xcom_push(key="grouped_events", value=grouped)
