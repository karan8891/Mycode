import base64
import json
import requests
from google.auth.transport import requests as auth_requests
from google.oauth2 import id_token
import google.auth

def main(event, context):
    if 'data' not in event:
        raise ValueError("No data field in the Pub/Sub message")

    # Decode Pub/Sub message
    message_data = base64.b64decode(event['data']).decode('utf-8')
    message = json.loads(message_data)

    bucket = message.get("bucket")
    object_name = message.get("object") or message.get("name")
    project_id = message.get("project_id")
    delete_after_transfer = message.get("delete_after_transfer", False)

    if not bucket or not object_name or not project_id:
        raise ValueError("Missing required fields in Pub/Sub message")

    # Composer Airflow Webserver URL
    dag_url = "https://<REPLACE-WITH-COMPOSER-WEBSERVER-URL>/api/experimental/dags/event_sts_transfer_dag/dag_runs"

    # Build DAG config
    dag_conf = {
        "bucket": bucket,
        "object": object_name,
        "project_id": project_id,
        "delete_after_transfer": delete_after_transfer
    }

    print("Parsed DAG configuration:", dag_conf)

    # Get ID token to authorize with Composer Webserver
    credentials, _ = google.auth.default()
    auth_req = auth_requests.Request()
    credentials.refresh(auth_req)
    id_token_val = credentials.token

    headers = {
        "Authorization": f"Bearer {id_token_val}",
        "Content-Type": "application/json"
    }

    # Trigger DAG
    response = requests.post(dag_url, headers=headers, json={"conf": dag_conf})

    if response.status_code not in [200, 201]:
        raise RuntimeError(f"Failed to trigger DAG: {response.status_code} {response.text}")

    print("Triggered DAG successfully.")
